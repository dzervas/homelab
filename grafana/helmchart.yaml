---
apiVersion: v1
kind: Namespace
metadata:
  name: grafana

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: grafana
  namespace: kube-system
  labels:
    logme: "true"
spec:
  chart: grafana
  repo: https://grafana.github.io/helm-charts
  version: 6.58.9
  targetNamespace: grafana
  valuesContent: |-
    rbac:
      namespaced: true
    persistence:
      enabled: true
      storageClassName: longhorn
    grafana.ini:
      auth:
        disable_login_form: true
        anonymous:
          enabled: false
        proxy:
          enabled: true
          header_name: X-WEBAUTH-USER
          header_property: username
          auto_sign_up: false
      server:
        domain: grafana.dzerv.art
        root_url: https://grafana.dzerv.art/

    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        nginx.ingress.kubernetes.io/auth-tls-verify-client: "on"
        nginx.ingress.kubernetes.io/auth-tls-secret: "cert-manager/client-ca-certificate"
        nginx.ingress.kubernetes.io/auth-tls-verify-depth: "1"
        nginx.ingress.kubernetes.io/auth-snippet: |
          proxy_set_header X-WEBAUTH-USER admin;
      hosts:
        - grafana.dzerv.art
      tls:
        - hosts:
            - grafana.dzerv.art
          secretName: grafana-k8s-dzervas-gr-cert
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Mimir
            type: prometheus
            url: http://mimir-nginx/prometheus
          - name: Loki
            type: loki
            url: http://loki:3100
